<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <title>Market Street Photos</title>
    <link rel="stylesheet" href="https://api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.css">

    <!-- Dependencies -->
    <script src="scripts/jquery/dist/jquery.js" type="text/javascript" charset="utf-8"></script>
    <script src="scripts/mapbox.js/mapbox.uncompressed.js" type="text/javascript" charset="utf-8"></script>
    <script src="scripts/lodash/lodash.js" type="text/javascript" charset="utf-8"></script>
    <script src="scripts/d3/d3.js" type="text/javascript" charset="utf-8"></script>
    <script src="scripts/turf/turf.js" type="text/javascript" charset="utf-8"></script>

    <script src="scripts/firebase/firebase.js" type="text/javascript" charset="utf-8"></script>
    <script src="scripts/moment/moment.js" type="text/javascript" charset="utf-8"></script>
    <script src="scripts/moment-timezone/builds/moment-timezone-with-data-2010-2020.js" type="text/javascript" charset="utf-8"></script>
    <!--script src="script.js"></script-->
    <!-- Social -->
    <script src="scripts/map.js" type="text/javascript" charset="utf-8"></script>
    <style>
      #map {
        height: 100%;
        width: 100%;
      }
    </style>
  </head>
  <body>

    <div id="map"></div>

    <script>
      var mapMain = "stevepepple.lbj8m1n3";

      var map = map = L.mapbox.map('map', mapMain, {
          attributionControl: false,
          maxZoom: 18,
          minZoom: 5
      }).setView([37.754392, -122.418503], 15);

      var circle_options = {
        color:'#4A90E2',
        opacity: 0.5,
        weight: 1,
        fillColor:'#4A90E2',
        fillOpacity: 0.5
      }

      var coord = L.latLng(37.754392, -122.418503);
      var circle = L.circle(coord, 20, circle_options).addTo(map);

      var coords = [[37.755432, -122.418800], [37.758621, -122.419057], [37.761844, -122.419401], [37.765067, -122.419701]];

      var market_photos = new Firebase("https://data-canvas.firebaseio.com/mission/");

      market_photos.once('value', function(snapshot) {
          snapshot.forEach(function(item){
            //console.log(item)
          })
      });

      getPhotosforPlaces();

      var interval = setInterval(function(){
        getPhotosforPlaces();
      }, 1000 * 15 * 60); // Try every 15 mins

      function getPhotosforPlaces() {
        console.log("Getting photos")
        for (var i = 0; i < coords.length; i++) {
          coords[i]
          var lat = coords[i][0];
          var lon = coords[i][1];
          getPhotos(lat, lon)
        }
      }

      setTimeout(function(){
        console.log("Stop Counting Photos")
        clearInterval(interval);
      }, 1000 *60 * 60 * 3 )


      function getPhotos(lat, lon){
        $.getJSON('/instagram?lat=' + lat + "&lng=" + lon, function(data){

           // Handle the case where there are no public photos near the sensor
           if (data.data.length == 0) {
             canvas.html('<div class="no-results">No recent photos</div>');
             return false;
           }

           // Sort by both number of comments and likes
           sorted = data.data.sort(function(a,b){
           //var a_score = a.comments.count + a.likes.count;
              //var b_score = b.comments.count + b.likes.count;
              var a_score =  a.likes.count;
              var b_score =  b.likes.count;
              return a_score - b_score;
           });

           //canvas.html("");
           _.each(sorted, function(item){

             var mission_photos = new Firebase("https://data-canvas.firebaseio.com/mission/");
             mission_photos.child(item.id).set(item);

             var time = moment.unix(item.created_time).toDate();
             console.log(time)

             var circle_options = {
               color:'#BD10E0',
               opacity: 0,
               weight: 1,
               fillColor:'#BD10E0',
               fillOpacity: 1.0
             }

             var coord = L.latLng(item.location.latitude, item.location.longitude);

             var circle = L.circle(coord, 12, circle_options).addTo(map);

           });
         });
      }


    </script>

  </body>

</html>
